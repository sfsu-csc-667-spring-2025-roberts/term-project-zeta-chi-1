<% layout('layouts/base') %>

<div class="max-w-xl mx-auto text-center">
  <h1 class="text-3xl font-bold mb-6">Available Games</h1>

  <!-- list -->
  <ul id="lobbyList" class="space-y-4"></ul>

  <!-- create new -->
  <button id="createBtn"
          class="mt-8 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
    Start a new game
  </button>
</div>

<script>
async function refresh() {
  const res = await fetch("/api/lobbies");
  const data = await res.json();
  const ul   = document.getElementById("lobbyList");
  ul.innerHTML = "";

  if (data.length === 0) {
    ul.innerHTML = "<li class='text-gray-500'>No open games yet.</li>";
  } else {
    data.forEach(l => {
      const li = document.createElement("li");
      li.className = "flex justify-between bg-white p-4 rounded shadow";
      li.innerHTML = `
        <span>${l.id} â€“ ${l.players}/2 players</span>
        ${l.status === "waiting"
          ? `<button class="join-btn bg-blue-600 text-white px-3 py-1 rounded"
                     data-id="${l.id}">
               Join
             </button>`
          : "<span class='text-gray-400'>In progress</span>"}`
      ul.appendChild(li);
    });
  }
}

document.addEventListener("click", async e => {
  if (e.target.matches(".join-btn")) {
    const id = e.target.dataset.id;
    await fetch(`/api/lobbies/${id}/join`, { method: "POST" });
    location.href = `/game/${id}`;             // TODO build game page later
  }
});

document.getElementById("createBtn").addEventListener("click", async () => {
  const name = prompt("Your nickname?", "Host");
  const res  = await fetch("/api/lobbies", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams({ host: name })
  });
  const lobby = await res.json();
  location.href = `/game/${lobby.id}`;         // TODO build game page later
});

refresh();
setInterval(refresh, 3000);   // poll every 3 s until we move to websockets
</script>
